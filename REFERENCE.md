# Reference
<!-- DO NOT EDIT: This document was generated by Puppet Strings -->

## Table of Contents

**Classes**

* [`duplicacy`](#duplicacy): This class manages the deployment of Duplicacy on a server.

**Defined types**

* [`duplicacy::backup`](#duplicacybackup): Generates a script & schedules it given the specified parameters
* [`duplicacy::filter`](#duplicacyfilter): Creates a filters file for this repository.
* [`duplicacy::repository`](#duplicacyrepository): A short summary of the purpose of this defined type.
* [`duplicacy::storage`](#duplicacystorage): This initializes a storage backend for a particular duplicacy repository.

## Classes

### duplicacy

A class to configure and manage duplicacy backup instances.

#### Examples

##### Configuring a local repo for root's home directory which is backed up once every hour

```puppet
duplicacy {
  local_repos          => [ 'root-home' ],
  repos                => {
    root-home          => {
      repo_path        => '/root',
      user             => 'root',
      storage_targets  => {
        default        => {
          target       => {
            url        => 'b2://pdemon-duplicacy-test',
            b2_id      => 'my-b2-id-is-a-secret',
            b2_app_key => 'so is my key'
          },
          encryption => {
            password => 'my-secret-password'
          },
        },
      },
      backup_schedules => {
        hourly => {
          storage_name => 'default',
          cron_entry   => {
            'minute'   => '30',
          },
          'threads'         => 4,
          'email_recipient' => phil@demona.co,
        },
      },
    },
  },
}
```

#### Parameters

The following parameters are available in the `duplicacy` class.

##### `package_name`

Data type: `Array[String]`

Package or list of packages needed to install duplicacy on this host.

##### `mail_package_name`

Data type: `Array[String]`

Package or list of packages needed to send email from this host.

##### `local_repos`

Data type: `Array[String]`

List of repo names which should be deployed on this machine. Note that
each repo must be defined in the `repos` parameter.

##### `repos`

Data type: `Hash[String,
    Hash[String,
      Variant[
        String,
        Array[String],
        Hash[String,
          Variant[
            String,
            Hash[String,
              Variant[
                String,
                Integer,
              ]
            ]
          ]
        ],
        Hash[String,
          Hash[String,
            Variant[
              String,
              Integer,
              Hash[String,
                Variant[
                  String,
                  Integer,
                ]
              ]
            ]
          ]
        ]
      ]
    ]
  ]`

A Hash where the keys are the names of the repositories to be deployed on
this system are stored. This is a very deep structure.

Default value: {}

## Defined types

### duplicacy::backup

This define handles the creation of a single backup schedule for the target
repository / storage combination. The schedule is carried out via a cron
object and a script which is stored in the $pref_dir/puppet/scripts/

#### Examples

##### Full configuration for a given backup job.

```puppet
duplicacy::backup { 'my-repo_daily':
  storage_name => 'default',
  repo_path    => '/backup/dir',
  pref_dir     => '/backup/dir/.duplicacy',
  user         => 'root',
  cron_entry   => {
    hour       => '1',
  },
  backup_tag      => 'daily',
  threads         => 4,
  hash_mode       => true,
  email_recipient => 'me@example.com',
}
```

##### Minimal configuration

```puppet
duplicacy::backup { 'my-repo_minimal':
  storage_name => 'default',
  repo_path    => '/backup/dir',
  pref_dir     => '/backup/dir/.duplicacy',
  user         => 'root',
  cron_entry   => {
    hour       => '*/6',
  },
}
```

#### Parameters

The following parameters are available in the `duplicacy::backup` defined type.

##### `storage_name`

Data type: `String`

Name of this particular storage backend as referenced by duplicacy for this
specific repository. Note that the backend named 'default' is the primary.

Default value: `undef`

##### `repo_path`

Data type: `String`

Directory in which this particular repository resides on this machine.

Default value: `undef`

##### `user`

Data type: `String`

User to whom this repository belongs.

Default value: `undef`

##### `pref_dir`

Data type: `Optional[String]`

Directory containing the duplicacy preferences for this repository.
Typically this is `${repo_path}/.duplicacy` however the application can
support alternate paths.

Default value: "${repo_path}/.duplicacy"

##### `cron_entry`

Data type: `Hash[String, Variant[String, Integer]]`

This parameter is used as an argument to the cron resource type, however,
several parameters are overridden directly. In particular, `user` and
`command` cannot be specified via remote arguments. For more detail see the
[puppet cron resource documentation](https://puppet.com/docs/puppet/5.5/types/cron.html).

Default value: {}

##### `backup_tag`

Data type: `Optional[String]`

This string will be set as the tag argument for each backup performed by
this job. These can be used by various duplicacy commands to filter to
specific snapshots.

Default value: `undef`

##### `threads`

Data type: `Optional[Integer]`

Number of parallel execution threads which will be spawned for this backup.
Note that this defaults to 1 and should not be greater than the number of
available threads on the target machine.

Default value: 1

##### `hash_mode`

Data type: `Optional[Boolean]`

Indicates whether a hash should be generated for each file to determine
whether a change has occured. The alternate approach simply uses file size
and modification timestamp. Note that this defaults to `false`.

Default value: `false`

##### `limit_rate`

Data type: `Optional[Integer]`

Maximum upload data rate in kilobytes per second (KB/s). Note that leaving
this unset implies no limit.

Default value: `undef`

##### `email_recipient`

Data type: `Optional[String]`

If specified, the job log will be sent to the specified address.

@note This assumes email is configured and working on this system.

Default value: `undef`

### duplicacy::filter

This type takes an ordered list of duplicity filter rules and inserts them
into the filters file for a specific repository. For more detail on the filter
rules see the [duplicacy
wiki](https://github.com/gilbertchen/duplicacy/wiki/Include-Exclude-Patterns).

#### Examples

##### 

```puppet
duplicacy::filter { 'my-repo_filters':
  pref_dir       => '/my/repo/dir/.duplicacy',
  user           => 'me',
  rules => [
    '+foo/bar/*',
    '-*',
  ],
}
```

#### Parameters

The following parameters are available in the `duplicacy::filter` defined type.

##### `pref_dir`

Data type: `String`

Path to the '.duplicacy' directory in which this filters file should be
defined.

Default value: `undef`

##### `user`

Data type: `String`

Who should own this file? Typically this is also who runs the backups and
owns the associated data.

Default value: `undef`

##### `rules`

Data type: `Array[String]`

An array of strings which each correspond to a line of the filter file. See
the https://github.com/gilbertchen/duplicacy/wiki/Include-Exclude-Patterns
page for more detail.

Default value: []

### duplicacy::repository

A description of what this defined type does

#### Examples

##### Fully configured repository

```puppet
duplicacy::repository { 'my-repo':
  repo_path        => '/path/to/the/directory',
  user             => 'me',
  storage_targets  => {
    'default'    => {
      target       => {
        url        => 'b2://backups-and-stuff',
        b2_id      => 'my-id',
        b2_app_key => 'my-key',
      },
      encryption   => {
        password   => 'secret-sauce',
        iterations => 32768,
      },
      chunk_parameters => {
        size           => 8388608,
        max            => 33554432,
        min            => 2097152,
    },
  },
  backup_schedules => [
    {
      storage_name => default,
      cron_entry   => {
        hour       => '7',
        minute     => '0',
        weekday    => ['1', '2', '6']
      },
      threads         => 6,
      hash_mode       => true,
      email_recipient => 'batman@batcave.com',
    },
  ],
  log_retention    => '5d'
}
```

#### Parameters

The following parameters are available in the `duplicacy::repository` defined type.

##### `repo_id`

Data type: `String`

The name of this particular repository. This is a namevar.

Default value: $name

##### `repo_path`

Data type: `String`

Absolute path to the directory to be backed up. Note that backup directories
should not be nested.

Default value: `undef`

##### `user`

Data type: `String`

The name of the user who owns this repository for a given server. This user
will also run the cron jobs for that system. Defaults to 'root'.

Default value: 'root'

##### `storage_targets`

Data type: `Hash[String, Variant[String, Hash[String, Variant[String, Hash[String, Variant[String, Integer]]]]]]`

A hash of duplicacy::storage types against which this repo should be
initialized. Note that there must be an entry named 'default'. Note that
several of the parameters which can be directly specified to the storage
subtype must be omitted here. Specifically, `repo_id`, `repo_path`, and
`user` as these are all overridden.

Default value: {}

##### `backup_schedules`

Data type: `Optional[Hash[String, Hash[String, Variant[String, Integer, Hash[String, Variant[String, Integer]]]]]]`

Optional[Hash[String, Hash[String, Variant[String, Integer, Hash[String, Variant[String, Integer]]]]]]
A list of parameters and schedules for the execution of a series of backups
of this repository. If no schedules are provided this machine will not
backup this repository.

@note The following parameters must not be specified: `user`, `repo_path`

Default value: {}

##### `filter_rules`

Data type: `Optional[Array[String]]`

An ordered list of valid include/exclude filters for duplicacy.

Default value: []

##### `log_retention`

Data type: `Optional[String]`

The amount of time to retain logs in the log directory. Note that this is
simply the age parameter to a
[tidy](https://puppet.com/docs/puppet/5.5/types/tidy.html#tidy-attribute-age)
resource.

Default value: '4w'

### duplicacy::storage

Each repository must have at least one storage backend defined. This
define handles the initialization of a repository against a specific backend.

#### Examples

##### Fully configured with all options set

```puppet
duplicacy::storage { 'my-repo_default':
  storage_name         => 'default',
  repo_id              => 'my-repo',
  repo_path            => '/mnt/backup/my/directory',
  target               => {
    url                => 'b2://duplicacy-primary',
    b2_id      => 'my-account-id-here',
    b2_app_key => 'this-app-key-here',
  },
  encryption    => {
    password    => 'super-secret-password',
    iterations  => 16384,
  },
  chunk_parameters => {
    size   => 4194304,
    max    => 16777216,
    min    => 1048576,
  },
}
```

#### Parameters

The following parameters are available in the `duplicacy::storage` defined type.

##### `storage_name`

Data type: `String`

Name of this particular storage backend as referenced by duplicacy for this
specific repository. Note that the backend named 'default' is the primary.

Default value: `undef`

##### `repo_id`

Data type: `String`

ID referencing this repository on the target storage backend.

Default value: `undef`

##### `repo_path`

Data type: `String`

Directory in which this particular repository resides on this machine.

Default value: `undef`

##### `user`

Data type: `String`

User to whom this repository belongs.

Default value: `undef`

##### `encryption`

Data type: `Optional[Hash[String, Variant[String, Integer]]]`

This hash includes two key parameters related to encryption.
* `password` - this is the password used to encrypt the config file
* `iterations` - the number of iterations to generate the block password.

@note `iterations` is optional and defaults to 16384, however, password must
be set.

If this hash is absent the data will not be encrypted.
See https://github.com/gilbertchen/duplicacy/wiki/Encryption for more
details.

Default value: {}

##### `target`

Data type: `Hash[String, Variant[String, Integer]]`

Hash containing a number of details for the target system. Currently only b2
is supported by this module.
* 'url' - the url to provide to the init command

b2 specific arguments
* `b2_id` - ID from your b2 account
* `b2_app_key` - the application key you generated for this bucket

Default value: {}

##### `chunk_parameters`

Data type: `Optional[Hash[String, Integer]]`

This hash includes three parameters defining how chunks are handled. The
entire hash is optional, as are the sub components.
* `size` - The target size of each chunk - defaults to 4M
* `max` - largest possible chunk size - defaults to $size * 4
* `min` - smallest possible chunk size - defaults to $size / 4

Default value: {}

