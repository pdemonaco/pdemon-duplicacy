# Reference

<!-- DO NOT EDIT: This document was generated by Puppet Strings -->

## Table of Contents

### Classes

* [`duplicacy`](#duplicacy): This class manages the deployment of Duplicacy on a server.

### Defined types

* [`duplicacy::backup`](#duplicacybackup): Generates a script & schedules it given the specified parameters
* [`duplicacy::filter`](#duplicacyfilter): Creates a filters file for this repository.
* [`duplicacy::prune`](#duplicacyprune): Generates a script & schedules it given the specified parameters
* [`duplicacy::repository`](#duplicacyrepository): A short summary of the purpose of this defined type.
* [`duplicacy::storage`](#duplicacystorage): This initializes a storage backend for a particular duplicacy repository.

### Data types

* [`Duplicacy::B2Url`](#duplicacyb2url): Backblaze b2 url - currently the only supported target type
* [`Duplicacy::BackupSchedule`](#duplicacybackupschedule): Backup schedule for a given storage target
* [`Duplicacy::EmailRecipient`](#duplicacyemailrecipient): A valid email address
* [`Duplicacy::KeepRange`](#duplicacykeeprange): Prune job parameters
* [`Duplicacy::PruneSchedule`](#duplicacypruneschedule): Prune schedule entry
* [`Duplicacy::PruneScheduleEntry`](#duplicacyprunescheduleentry): Schedule prune jobs against this or other repos in the same storage
* [`Duplicacy::RepositoryEntry`](#duplicacyrepositoryentry): Configures a directory as a duplicacy backup repository
* [`Duplicacy::ScheduleEntry`](#duplicacyscheduleentry): A basic alias for the cron resource type
* [`Duplicacy::SnapshotID`](#duplicacysnapshotid): Name of the backup repository associated with this storage
* [`Duplicacy::StorageChunkParams`](#duplicacystoragechunkparams): Configure the attributes of chunks for this storage target
* [`Duplicacy::StorageEncryption`](#duplicacystorageencryption): Configure encryption for the given storage
* [`Duplicacy::StorageTarget`](#duplicacystoragetarget): A specific backend storage for the current repository
* [`Duplicacy::StorageTargetB2`](#duplicacystoragetargetb2): Hash containing a number of details for the target system. Currently only b2 is supported by this module. * 'url' - the url to provide to the
* [`Duplicacy::StorageTargetType`](#duplicacystoragetargettype): Possible storage target types

## Classes

### <a name="duplicacy"></a>`duplicacy`

A class to configure and manage duplicacy backup instances.

#### Examples

##### Configuring a local repo for root's home directory which is backed up once every hour

```puppet
duplicacy {
  local_repos          => [ 'root-home' ],
  repos                => {
    root-home          => {
      repo_path        => '/root',
      user             => 'root',
      storage_targets  => {
        default        => {
          target       => {
            url        => 'b2://pdemon-duplicacy-test',
            b2_id      => 'my-b2-id-is-a-secret',
            b2_app_key => 'so is my key'
          },
          encryption => {
            password => 'my-secret-password'
          },
        },
      },
      backup_schedules => {
        hourly => {
          storage_name => 'default',
          cron_entry   => {
            'minute'   => '30',
          },
          'threads'         => 4,
          'email_recipient' => phil@demona.co,
        },
      },
      prune_schedules          => {
        retain-7d1d-30d1w-90d0 => {
          storage_name         => default,
          schedules            => {
            daily-prune        => {
              cron_entry       => {
                repo_id        => 'my-repo',
                hour           => '0',
              },
            },
          },
          keep_ranges     => {
            { interval => 0, max_age  => 90 },
            { interval => 7, max_age  => 30 },
            { interval => 1, max_age  => 7 },
          },
          threads         => 6,
          email_recipient => 'phil@demona.co',
        },
      },
    },
  },
}
```

#### Parameters

The following parameters are available in the `duplicacy` class:

* [`package_name`](#package_name)
* [`mail_package_name`](#mail_package_name)
* [`local_repos`](#local_repos)
* [`repos`](#repos)

##### <a name="package_name"></a>`package_name`

Data type: `String`

Package or list of packages needed to install duplicacy on this host.

##### <a name="mail_package_name"></a>`mail_package_name`

Data type: `String`

Package or list of packages needed to send email from this host.

##### <a name="local_repos"></a>`local_repos`

Data type: `Array[String]`

List of repo names which should be deployed on this machine. Note that
each repo must be defined in the `repos` parameter.

##### <a name="repos"></a>`repos`

Data type: `Hash[Duplicacy::SnapshotID, Duplicacy::RepositoryEntry]`

A Hash where the keys are the names of the repositories to be deployed on
this system are stored. This is a very deep structure.

Default value: `{}`

## Defined types

### <a name="duplicacybackup"></a>`duplicacy::backup`

This define handles the creation of a single backup schedule for the target
repository / storage combination. The schedule is carried out via a cron
object and a script which is stored in the $pref_dir/puppet/scripts/

 (https://puppet.com/docs/puppet/5.5/types/cron.html).

#### Examples

##### Full configuration for a given backup job.

```puppet
duplicacy::backup { 'my-repo_daily':
  storage_name => 'default',
  repo_path    => '/backup/dir',
  pref_dir     => '/backup/dir/.duplicacy',
  user         => 'root',
  cron_entry   => {
    hour       => '1',
  },
  backup_tag      => 'daily',
  threads         => 4,
  hash_mode       => true,
  email_recipient => 'me@example.com',
}
```

##### Minimal configuration

```puppet
duplicacy::backup { 'my-repo_minimal':
  storage_name => 'default',
  repo_path    => '/backup/dir',
  pref_dir     => '/backup/dir/.duplicacy',
  user         => 'root',
  cron_entry   => {
    hour       => '*/6',
  },
}
```

#### Parameters

The following parameters are available in the `duplicacy::backup` defined type:

* [`storage_name`](#storage_name)
* [`repo_path`](#repo_path)
* [`user`](#user)
* [`pref_dir`](#pref_dir)
* [`cron_entry`](#cron_entry)
* [`backup_tag`](#backup_tag)
* [`threads`](#threads)
* [`hash_mode`](#hash_mode)
* [`limit_rate`](#limit_rate)
* [`email_recipient`](#email_recipient)

##### <a name="storage_name"></a>`storage_name`

Data type: `String[1]`

Name of this particular storage backend as referenced by duplicacy for this
specific repository. Note that the backend named 'default' is the primary.

##### <a name="repo_path"></a>`repo_path`

Data type: `String[1]`

Directory in which this particular repository resides on this machine.

##### <a name="user"></a>`user`

Data type: `String[1]`

User to whom this repository belongs.

##### <a name="pref_dir"></a>`pref_dir`

Data type: `Optional[String]`

Directory containing the duplicacy preferences for this repository.
Typically this is `${repo_path}/.duplicacy` however the application can
support alternate paths.

Default value: `"${repo_path}/.duplicacy"`

##### <a name="cron_entry"></a>`cron_entry`

Data type: `Duplicacy::ScheduleEntry`

This parameter is used as an argument to the cron resource type, however,
several parameters are overridden directly. In particular, `user` and
`command` cannot be specified via remote arguments. For more detail see the

Default value: `{}`

##### <a name="backup_tag"></a>`backup_tag`

Data type: `Optional[String]`

This string will be set as the tag argument for each backup performed by
this job. These can be used by various duplicacy commands to filter to
specific snapshots.

Default value: ``undef``

##### <a name="threads"></a>`threads`

Data type: `Optional[Integer]`

Number of parallel execution threads which will be spawned for this backup.
Note that this defaults to 1 and should not be greater than the number of
available threads on the target machine.

Default value: `1`

##### <a name="hash_mode"></a>`hash_mode`

Data type: `Optional[Boolean]`

Indicates whether a hash should be generated for each file to determine
whether a change has occured. The alternate approach simply uses file size
and modification timestamp. Note that this defaults to `false`.

Default value: ``false``

##### <a name="limit_rate"></a>`limit_rate`

Data type: `Optional[Integer]`

Maximum upload data rate in kilobytes per second (KB/s). Note that leaving
this unset implies no limit.

Default value: ``undef``

##### <a name="email_recipient"></a>`email_recipient`

Data type: `Optional[String]`

If specified, the job log will be sent to the specified address.

@note This assumes email is configured and working on this system.

Default value: ``undef``

### <a name="duplicacyfilter"></a>`duplicacy::filter`

This type takes an ordered list of duplicity filter rules and inserts them
into the filters file for a specific repository. For more detail on the filter
rules see the [duplicacy
wiki](https://github.com/gilbertchen/duplicacy/wiki/Include-Exclude-Patterns).

#### Examples

##### 

```puppet
duplicacy::filter { 'my-repo_filters':
  pref_dir       => '/my/repo/dir/.duplicacy',
  user           => 'me',
  rules => [
    '+foo/bar/*',
    '-*',
  ],
}
```

#### Parameters

The following parameters are available in the `duplicacy::filter` defined type:

* [`pref_dir`](#pref_dir)
* [`user`](#user)
* [`rules`](#rules)

##### <a name="pref_dir"></a>`pref_dir`

Data type: `Stdlib::Absolutepath`

Path to the '.duplicacy' directory in which this filters file should be
defined.

##### <a name="user"></a>`user`

Data type: `String[1]`

Who should own this file? Typically this is also who runs the backups and
owns the associated data.

##### <a name="rules"></a>`rules`

Data type: `Array[String]`

An array of strings which each correspond to a line of the filter file. See
the https://github.com/gilbertchen/duplicacy/wiki/Include-Exclude-Patterns
page for more detail.

Default value: `[]`

### <a name="duplicacyprune"></a>`duplicacy::prune`

This define handles the creation of a single backup schedule for the target
repository / storage combination. The schedule is carried out via a cron
object and a script which is stored in the $pref_dir/puppet/scripts/

#### Examples

##### Full configuration for a given job type.

```puppet
duplicacy::prune { 'my-repo_weekly':
  storage_name       => 'default',
  repo_path          => '/backup/dir',
  pref_dir           => '/backup/dir/.duplicacy',
  user               => 'root',
  schedules          => {
    'sunday-midnight' => {
      repo_id    => 'my-repo'
      cron_entry      => {
        hour          => '0',
        weekday       => '0',
      },
    },
    'saturday-midnight-other-repo' => {
      repo_id    => 'my-repo'
      cron_entry      => {
        hour          => '0',
        weekday       => '6',
      },
    },
  },
  keep_ranges     => [
    { interval => 0, min_age => 365 },
    { interval => 30, min_age => 180 },
    { interval => 7, min_age => 30 },
    { interval => 1, min_age => 7 },
  ],
  backup_tags     => [
    'daily',
    'weekly',
    'test',
  ],
  threads         => 4,
  email_recipient => 'me@example.com',
}
```

##### Minimal configuration

```puppet
duplicacy::backup { 'my-repo_minimal':
  storage_name => 'default',
  repo_path    => '/backup/dir',
  pref_dir     => '/backup/dir/.duplicacy',
  user         => 'root',
  keep_ranges  => [
    { interval => 0, min_age => 90 },
  schedules => {
    'daily-midnight' => {
      repo_id    => 'my-repo'
      cron_entry => {
        hour => '0',
      },
    },
  },
}
```

#### Parameters

The following parameters are available in the `duplicacy::prune` defined type:

* [`repo_path`](#repo_path)
* [`user`](#user)
* [`pref_dir`](#pref_dir)
* [`schedules`](#schedules)
* [`backup_tags`](#backup_tags)
* [`keep_ranges`](#keep_ranges)
* [`exhaustive`](#exhaustive)
* [`threads`](#threads)
* [`email_recipient`](#email_recipient)
* [`default_id`](#default_id)

##### <a name="repo_path"></a>`repo_path`

Data type: `String[1]`

Directory in which this particular repository resides on this machine.

##### <a name="user"></a>`user`

Data type: `String[1]`

User to whom this repository belongs.

##### <a name="pref_dir"></a>`pref_dir`

Data type: `String`

Directory containing the duplicacy preferences for this repository.
Typically this is `${repo_path}/.duplicacy` however the application can
support alternate paths.

Default value: `"${repo_path}/.duplicacy"`

##### <a name="schedules"></a>`schedules`

Data type: `Hash[String, Duplicacy::PruneScheduleEntry]`

Each entry in this parameter has two mandatory components:
* `repo_id` - ID of the snapshot to be pruned. Note that this can be any
  repository which uses the same storage backend and credentials.
* `cron_entry` - argument to the cron resource type, however,
 several parameters are overridden directly. In particular, *user* and
 *command* cannot be specified via remote arguments. For more detail see the
 (https://puppet.com/docs/puppet/5.5/types/cron.html).

Additionally, the following optional parameter can be included
* `storage_name` - Name of this particular storage backend as
  referenced by duplicacy for this specific repository. Note that the
  backend named 'default' is the primary.

Default value: `{}`

##### <a name="backup_tags"></a>`backup_tags`

Data type: `Optional[Array[String]]`

Limit the prune to impact only backups matching the specified tag or tags.

Default value: `[]`

##### <a name="keep_ranges"></a>`keep_ranges`

Data type: `Array[Duplicacy::KeepRange]`

An ordered list of hashes where each hash contains two values:
* `interval` - 1 snapshot will be kept for each interval of this length in days
* `min_age` - policy applies to snapshots at least this number of days old

These **must** be sorted by their M values in decreasing order - the module
doesn't do this for you at the moment!

Default value: `[]`

##### <a name="exhaustive"></a>`exhaustive`

Data type: `Boolean`

If this is enabled prune will remove unreferenced chunks created by other
scenarios as well as files which don't appear to be backup chunks.

Default value: ``false``

##### <a name="threads"></a>`threads`

Data type: `Optional[Integer]`

Number of parallel execution threads which will be spawned for this backup.
Note that this defaults to 1 and should not be greater than the number of
available threads on the target machine.

Default value: `1`

##### <a name="email_recipient"></a>`email_recipient`

Data type: `Optional[Duplicacy::EmailRecipient]`

If specified, the job log will be sent to the specified address.

Default value: ``undef``

##### <a name="default_id"></a>`default_id`

Data type: `String[1]`

This is the name of the current repository. It is used if repo_id is left
out of a given prune schedule entry.

@note This assumes email is configured and working on this system.

### <a name="duplicacyrepository"></a>`duplicacy::repository`

Each entity of this type corresponds to a distinct repository for duplicacy to
back up. These repositories can potentially share backing storage resources.
Additionally, a repository can be declared simply for pruning purposes.

#### Examples

##### Fully configured repository

```puppet
duplicacy::repository { 'my-repo':
  repo_path        => '/path/to/the/directory',
  user             => 'me',
  storage_targets  => {
    'default'    => {
      target       => {
        url        => 'b2://backups-and-stuff',
        b2_id      => 'my-id',
        b2_app_key => 'my-key',
      },
      encryption   => {
        password   => 'secret-sauce',
        iterations => 32768,
      },
      chunk_parameters => {
        size           => 8388608,
        max            => 33554432,
        min            => 2097152,
    },
  },
  backup_schedules => {
    tri-weekly-0700 => {
      storage_name => default,
      cron_entry   => {
        hour       => '7',
        minute     => '0',
        weekday    => ['1', '2', '6']
      },
      threads         => 6,
      hash_mode       => true,
      email_recipient => 'batman@batcave.com',
    },
  },
  prune_schedules          => {
    retain-7d1d-30d1w-90d0 => {
      storage_name         => default,
      schedules            => {
        daily-prune        => {
          cron_entry       => {
            repo_id        => 'my-repo',
            hour           => '0',
          },
        },
      },
      keep_ranges     => {
        { interval => 0, max_age  => 90 },
        { interval => 7, max_age  => 30 },
        { interval => 1, max_age  => 7 },
      },
      threads         => 6,
      email_recipient => 'batman@batcave.com',
    },
  },
  log_retention   => '5d'
}
```

#### Parameters

The following parameters are available in the `duplicacy::repository` defined type:

* [`repo_id`](#repo_id)
* [`repo_path`](#repo_path)
* [`user`](#user)
* [`storage_targets`](#storage_targets)
* [`backup_schedules`](#backup_schedules)
* [`prune_schedules`](#prune_schedules)
* [`filter_rules`](#filter_rules)
* [`log_retention`](#log_retention)

##### <a name="repo_id"></a>`repo_id`

Data type: `String[1]`

The name of this particular repository. This is a namevar.

Default value: `$name`

##### <a name="repo_path"></a>`repo_path`

Data type: `String[1]`

Absolute path to the directory to be backed up. Note that backup directories
should not be nested.

##### <a name="user"></a>`user`

Data type: `String[1]`

The name of the user who owns this repository for a given server. This user
will also run the cron jobs for that system. Defaults to 'root'.

Default value: `'root'`

##### <a name="storage_targets"></a>`storage_targets`

Data type: `Hash[String, Duplicacy::StorageTarget]`

A hash of duplicacy::storage types against which this repo should be
initialized. Note that there must be an entry named 'default'. Note that
several of the parameters which can be directly specified to the storage
subtype must be omitted here. Specifically, `repo_id`, `repo_path`, and
`user` as these are all overridden.

Default value: `{}`

##### <a name="backup_schedules"></a>`backup_schedules`

Data type: `Optional[Hash[String, Duplicacy::BackupSchedule]]`

Optional[Hash[String, Hash[String, Variant[String, Integer, Hash[String, Variant[String, Integer]]]]]]
A list of parameters and schedules for the execution of a series of backups
of this repository. If no schedules are provided this machine will not
backup this repository.

@note The following parameters must not be specified: `user`, `repo_path`

Default value: `{}`

##### <a name="prune_schedules"></a>`prune_schedules`

Data type: `Optional[Hash[String, Duplicacy::PruneSchedule]]`

A list of parameters and schedules for the execution of a series of prunes
of this repository. If no schedules are provided this machine will not
prune this repository.

@note The following parameters must not be specified: `user`, `repo_path`

Default value: `{}`

##### <a name="filter_rules"></a>`filter_rules`

Data type: `Optional[Array[String]]`

An ordered list of valid include/exclude filters for duplicacy.

Default value: `[]`

##### <a name="log_retention"></a>`log_retention`

Data type: `Optional[String]`

The amount of time to retain logs in the log directory. Note that this is
simply the age parameter to a
[tidy](https://puppet.com/docs/puppet/5.5/types/tidy.html#tidy-attribute-age)
resource.

Default value: `'4w'`

### <a name="duplicacystorage"></a>`duplicacy::storage`

Each repository must have at least one storage backend defined. This
define handles the initialization of a repository against a specific backend.

#### Examples

##### Fully configured with all options set

```puppet
duplicacy::storage { 'my-repo_default':
  storage_name         => 'default',
  repo_id              => 'my-repo',
  repo_path            => '/mnt/backup/my/directory',
  target               => {
    url                => 'b2://duplicacy-primary',
    b2_id      => 'my-account-id-here',
    b2_app_key => 'this-app-key-here',
  },
  encryption    => {
    password    => 'super-secret-password',
    iterations  => 16384,
  },
  chunk_parameters => {
    size   => 4194304,
    max    => 16777216,
    min    => 1048576,
  },
}
```

#### Parameters

The following parameters are available in the `duplicacy::storage` defined type:

* [`storage_name`](#storage_name)
* [`repo_id`](#repo_id)
* [`repo_path`](#repo_path)
* [`user`](#user)
* [`encryption`](#encryption)
* [`target`](#target)
* [`chunk_parameters`](#chunk_parameters)

##### <a name="storage_name"></a>`storage_name`

Data type: `String[1]`

Name of this particular storage backend as referenced by duplicacy for this
specific repository. Note that the backend named 'default' is the primary.

##### <a name="repo_id"></a>`repo_id`

Data type: `String[1]`

ID referencing this repository on the target storage backend.

##### <a name="repo_path"></a>`repo_path`

Data type: `Stdlib::Absolutepath`

Directory in which this particular repository resides on this machine.

##### <a name="user"></a>`user`

Data type: `String[1]`

User to whom this repository belongs.

##### <a name="encryption"></a>`encryption`

Data type: `Optional[Duplicacy::StorageEncryption]`

This hash includes two key parameters related to encryption.
* `password` - this is the password used to encrypt the config file
* `iterations` - the number of iterations to generate the block password.

@note `iterations` is optional and defaults to 16384, however, password must
be set.

If this hash is absent the data will not be encrypted.
See https://github.com/gilbertchen/duplicacy/wiki/Encryption for more
details.

Default value: ``undef``

##### <a name="target"></a>`target`

Data type: `Duplicacy::StorageTargetType`

Hash containing a number of details for the target system. Currently only b2
is supported by this module.
* 'url' - the url to provide to the init command

b2 specific arguments
* `b2_id` - ID from your b2 account
* `b2_app_key` - the application key you generated for this bucket

##### <a name="chunk_parameters"></a>`chunk_parameters`

Data type: `Optional[Duplicacy::StorageChunkParams]`

This hash includes three parameters defining how chunks are handled. The
entire hash is optional, as are the sub components.
* `size` - The target size of each chunk - defaults to 4M
* `max` - largest possible chunk size - defaults to $size * 4
* `min` - smallest possible chunk size - defaults to $size / 4

Default value: ``undef``

## Data types

### <a name="duplicacyb2url"></a>`Duplicacy::B2Url`

Backblaze b2 url - currently the only supported target type

Alias of

```puppet
Pattern[/(?i:^b2:\/\/)/]
```

### <a name="duplicacybackupschedule"></a>`Duplicacy::BackupSchedule`

Backup schedule for a given storage target

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacyemailrecipient"></a>`Duplicacy::EmailRecipient`

A valid email address

Alias of

```puppet
Pattern[/[[:alnum:]._%+-]+@[[:alnum:].-]+\.[[:alnum:]]{2,}/]
```

### <a name="duplicacykeeprange"></a>`Duplicacy::KeepRange`

Prune job parameters

Alias of

```puppet
Struct[=>]
```

#### Parameters

The following parameters are available in the `Duplicacy::KeepRange` data type:

* [`interval`](#interval)
* [`min_age`](#min_age)

##### <a name="interval"></a>`interval`

One snapshot will be kept for each interval of this length in days

##### <a name="min_age"></a>`min_age`

This policy applies to snapshots at least this number of days old

### <a name="duplicacypruneschedule"></a>`Duplicacy::PruneSchedule`

Prune schedule entry

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacyprunescheduleentry"></a>`Duplicacy::PruneScheduleEntry`

Schedule prune jobs against this or other repos in the same storage

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacyrepositoryentry"></a>`Duplicacy::RepositoryEntry`

Configures a directory as a duplicacy backup repository

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacyscheduleentry"></a>`Duplicacy::ScheduleEntry`

A basic alias for the cron resource type

Alias of

```puppet
Hash[String, Variant[
    String,
    Integer,
    Array,
  ]]
```

### <a name="duplicacysnapshotid"></a>`Duplicacy::SnapshotID`

Name of the backup repository associated with this storage

Alias of

```puppet
Pattern[/[a-zA-Z_-]+/]
```

### <a name="duplicacystoragechunkparams"></a>`Duplicacy::StorageChunkParams`

Configure the attributes of chunks for this storage target

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacystorageencryption"></a>`Duplicacy::StorageEncryption`

Configure encryption for the given storage

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacystoragetarget"></a>`Duplicacy::StorageTarget`

A specific backend storage for the current repository

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacystoragetargetb2"></a>`Duplicacy::StorageTargetB2`

Hash containing a number of details for the target system. Currently only b2
is supported by this module.
* 'url' - the url to provide to the init command

b2 specific arguments
* `b2_id` - ID from your b2 account
* `b2_app_key` - the application key you generated for this bucket

Alias of

```puppet
Struct[=>]
```

### <a name="duplicacystoragetargettype"></a>`Duplicacy::StorageTargetType`

Possible storage target types

Alias of

```puppet
Variant[Duplicacy::StorageTargetB2]
```

